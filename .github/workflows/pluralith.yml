name: Pluralith Workflox
run-name: Pluralith Workflow
on:
    push:
        branches:
            - main
    workflow_dispatch:
jobs:
    pluralith:
        name: Pluralith Graph Generation
        runs-on: ubuntu-latest
        steps:
            - name: Update Ubuntu
              run: sudo apt-get update

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                aws-region: us-east-1

            - name: Mkdir for Pluralith Executables
              run: mkdir pluralith-executables

            - name: Download Pluralith Executables from S3 bucket
              run: aws s3 sync s3://pluralith-executables/ ./pluralith-executables

            - name: Change permissions for Pluralith Executables
              run: chmod +x ./pluralith-executables/pluralith && chmod +x ./pluralith-executables/pluralith-cli-graphing

            - name: Check executables have been downloaded and permissions have been set
              run: ls -la ./pluralith-executables

            - name: Add pluralith to PATH
              run: mv ./pluralith-executables/pluralith /usr/local/bin/pluralith

            - name: Pluralith login
              run: pluralith login --api-key ${{ secrets.PLURALITH_API_KEY }}

            - name: Check whether the Pluralith directory exists
              run: ls -la ~/Pluralith

            - name: Move pluralith-cli-graphing to the Pluralith directory
              run: mv ./pluralith-executables/pluralith-cli-graphing ~/Pluralith/bin/

            - name: Check whether the pluralith-cli-graphing executable has been moved to the Pluralith directory
              run: ls -la ~/Pluralith/bin/

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_wrapper: false

            - name: Download Terragrunt
              run: >-
                wget
                https://github.com/gruntwork-io/terragrunt/releases/download/v0.50.6/terragrunt_linux_amd64
                && mv terragrunt_linux_amd64 terragrunt && chmod u+x terragrunt && mv
                terragrunt /usr/local/bin/terragrunt

            - name: Terragrunt Version Check
              working-directory: infrastructure/skyu-vpc-pluralith
              run: terragrunt version                

            - name: Terragrunt Init
              working-directory: infrastructure/skyu-vpc-pluralith
              run: terragrunt init --terragrunt-non-interactive

            - name: Look at the files in the skyu-vpc-pluralith directory
              run: ls -la ./infrastructure/skyu-vpc-pluralith/.terragrunt-cache

            - name: Find the cache directory containing providers.tf
              id: cache-dir
              run: |
                # Find the directory containing provider.tf in the cache
                CACHE_DIR=$(find ./infrastructure/skyu-vpc-pluralith/.terragrunt-cache -type f -name "provider.tf" -exec dirname {} \;)
                echo "Cache directory found: $CACHE_DIR"
                echo "CACHE_DIR=$CACHE_DIR" >> $GITHUB_ENV

            - name: Move providers.tf from the cache
              run: |
                # Copy the provider.tf file from the found cache directory
                if [ -f "$CACHE_DIR/provider.tf" ]; then
                  cp "$CACHE_DIR/provider.tf" ./infrastructure/skyu-vpc-pluralith/provider.tf
                fi

            - name: Verify the providers.tf file has been copied
              run: |
                cat ./infrastructure/skyu-vpc-pluralith/provider.tf
                
            - name: Install hcl2json
              run: |
                sudo apt-get install -y golang
                wget https://github.com/hashicorp/hcl/releases/download/v0.8.0/hcl2json_linux_amd64 -O /usr/local/bin/hcl2json
                chmod +x /usr/local/bin/hcl2json
  
            - name: Convert Terragrunt HCL to JSON
              run: |
                hcl2json ./infrastructure/skyu-vpc-pluralith/terragrunt.hcl > terragrunt.json
  
            - name: Extract inputs and create terraform.tfvars
              run: |
                # Use Python to read the JSON and extract the inputs
                python3 -c "
                import json
                
                # Load the converted JSON file
                with open('terragrunt.json', 'r') as f:
                    terragrunt_data = json.load(f)
                
                # Extract the 'inputs' section
                inputs = terragrunt_data.get('inputs', {})
                
                # Create terraform.tfvars content
                tfvars_content = ''
                for key, value in inputs.items():
                    tfvars_content += f'{key} = {repr(value)}\n'
                
                # Write the content to terraform.tfvars
                tfvars_file = './infrastructure/skyu-vpc-pluralith/terraform.tfvars'
                with open(tfvars_file, 'w') as f:
                    f.write(tfvars_content)
                
                print('terraform.tfvars file has been generated at:', tfvars_file)
                                "    
                                                      
            - name: Verify terraform.tfvars file
              run: |
                cat ./infrastructure/skyu-vpc-pluralith/terraform.tfvars